<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Minecraft-Style Museum</title>
    <style>
        body { margin: 0; overflow: hidden; background-color: #000; }
        canvas { display: block; }
        #instructions {
            position: fixed;
            top: 10px;
            left: 10px;
            color: white;
            background: rgba(0,0,0,0.7);
            padding: 15px;
            border-radius: 5px;
            font-family: Arial, sans-serif;
            z-index: 100;
            max-width: 300px;
        }
        #loading {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.9);
            color: white;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            font-family: Arial, sans-serif;
            z-index: 200;
        }
        #loadingBar {
            width: 300px;
            height: 20px;
            background: #333;
            border-radius: 5px;
            margin-top: 20px;
        }
        #loadingProgress {
            height: 100%;
            width: 0%;
            background: #5d8c3a;
            border-radius: 5px;
            transition: width 0.3s;
        }
        #roomInfo {
            position: fixed;
            bottom: 20px;
            left: 20px;
            color: white;
            background: rgba(0,0,0,0.7);
            padding: 10px;
            border-radius: 5px;
            font-family: 'Minecraft', Arial, sans-serif;
            transition: opacity 0.5s;
            opacity: 0;
        }
        #customizer {
            position: fixed;
            top: 10px;
            right: 10px;
            background: rgba(0,0,0,0.7);
            padding: 15px;
            border-radius: 5px;
            color: white;
            font-family: 'Minecraft', Arial, sans-serif;
            z-index: 100;
            display: none;
        }
        #customizer input {
            width: 100%;
            margin-bottom: 10px;
            font-family: 'Minecraft', Arial, sans-serif;
        }
        #customizer button {
            background: #5d8c3a;
            border: 2px solid #3f6527;
            padding: 5px 10px;
            color: white;
            font-family: 'Minecraft', Arial, sans-serif;
            cursor: pointer;
        }
    </style>
</head>
<body>
    <div id="loading">
        <h2 style="font-family: 'Minecraft', Arial, sans-serif;">Loading Minecraft Museum...</h2>
        <div id="loadingBar"><div id="loadingProgress"></div></div>
    </div>
    <div id="instructions">
        <h3>Minecraft Art Museum</h3>
        <p>Click to start<br>
        WASD to move<br>
        Mouse to look around<br>
        SPACE to jump<br>
        SHIFT to sprint<br>
        E to toggle image customizer<br>
        C to crouch</p>
    </div>
    <div id="roomInfo"></div>
    <div id="customizer">
        <h3>Customize Artwork</h3>
        <p>Target a painting and enter a new URL:</p>
        <input type="text" id="imageUrl" placeholder="Enter image URL">
        <input type="text" id="imageTitle" placeholder="Enter title">
        <input type="text" id="imageArtist" placeholder="Enter artist">
        <button id="updateImage">Update Artwork</button>
    </div>
    <script type="module">
        import * as THREE from 'https://cdn.jsdelivr.net/npm/three@0.132.2/build/three.module.js';
        
        // Scene setup with optimized parameters
        const scene = new THREE.Scene();
        scene.background = new THREE.Color(0x71b5db); // Minecraft-like sky blue
        scene.fog = new THREE.Fog(0x71b5db, 20, 40);

        const camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 50);
        
        const renderer = new THREE.WebGLRenderer({ 
            antialias: false, // More Minecraft-like blocky rendering
            powerPreference: "high-performance"
        });
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
        renderer.shadowMap.enabled = true;
        renderer.shadowMap.type = THREE.PCFSoftShadowMap;
        document.body.appendChild(renderer.domElement);

        // Loading manager
        const loadManager = new THREE.LoadingManager();
        let totalItems = 0;
        let loadedItems = 0;
        
        loadManager.onStart = function(url, itemsLoaded, itemsTotal) {
            totalItems = itemsTotal;
        };
        
        loadManager.onLoad = function() {
            document.getElementById('loading').style.display = 'none';
        };
        
        loadManager.onProgress = function(url, itemsLoaded, itemsTotal) {
            loadedItems = itemsLoaded;
            const progress = (itemsLoaded / itemsTotal) * 100;
            document.getElementById('loadingProgress').style.width = progress + '%';
        };
        
        const textureLoader = new THREE.TextureLoader(loadManager);

        // Minecraft-style texture paths - using direct base64 encoded textures for reliability
        const textureData = {
            oakPlanks: 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAA+UlEQVQ4y6WTsUrDUBSGvxsbaJEsttLBFEFEJ2dX8Rl8CJ9CfA9Cd+kgWKFQ6SC4KS4iSKE4lJAYhOaecwtNlJJWEH/48RP4zn8O5xwAXGUGqEopNwNr7VDkhuAOjgzQ0lpP2u32dLFYfNd1PZUkSQaUvzpYa29FGVBaa/f5+fWtLMunaZrezOfzgzAML4IguIyi6FJFUbSztXKotR40Gg0MBoP5bDb7APA5Ho+fwzA8rKpqa+UENsaYO5FhURRPRVG8GmMuQRQREQnG4/FL0zQAeJ1Op3f9fn/XWnuhiOgEwCaAj6qqptPJ5A5ACmBNRCkRdffc/wX+vfgBDUZa8JK+S9kAAAAASUVORK5CYII=',
            stoneBricks: 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAASElEQVQ4y2P8//8/AyWAiYFCQGUD/jfM/4+OsaljfECpAaMGjBoAAzA/YOTGpxYXYIIKkmcALjBqwKgBgxsDsc0Jxv//GSkNBwBJphGDSJxbvwAAAABJRU5ErkJggg==',
            oakLog: 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAPklEQVQ4y2P8//8/AyWAiYFCMGrAqAFQEAVsAArQxZkY/kMwPjUgMGrAqAGEDYD5AcMPDDWEAMuoAUPaAADWFRDOYALxJQAAAABJRU5ErkJggg==',
            oakLogTop: 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAdElEQVQ4y2P8//8/AyWAiYFCMGrAqAFQEAVs+A8FhNQwMfz/3/AfhPGpAYNRA0YNgBrQyI3TgIb5UENwGnA0wBPrTCAGGYLTgDJ3ORZIG7mh8gwM6AYxMqIYArORHE/EhgNZiQkrIC8pYcPkpUVsgJzUCAB3bBxR8hBVsgAAAABJRU5ErkJggg==',
            polishedAndesite: 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAMklEQVQ4y2NkYGD4z0ABYIIqZGFgYKCoYkYGKKBoMAys69evY2BkZBzYwBg1YNSAwQQA7QETlZ/BPQQAAAAASUVORK5CYII=',
            birchPlanks: 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAO0lEQVQ4y2P8//8/AyWAiYFCMGrAqAEoIAoIMTEDYTMTAwMTIQUMDHBXMDEzMTDiUsA4mgpHDRg1gBwAAJKIJ/HXnRVEAAAAAElFTkSuQmCC',
            glowstone: 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAaElEQVQ4y82SUQrAIAxDk6HX9Oa2n91l2EAU3CfEH3EEX1oaRQAwK3YAWE9L2xM4AdnDG4CPXDiAAzAEEgC6QOKMkTnfqg4kAR2AYqUkKA4kAMUpiSorJALFKUn1fYAIK43xUlNu4gJZnTv0ccsBfAAAAABJRU5ErkJggg==',
            smoothStone: 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAM0lEQVQ4y2NkYGD4z0ABYIIqZGFgYKCoYkYGKKBoMAys69evY2BkZBzYwBg1YNSAwQQA7QETlZ/BPQQAAAAASUVORK5CYII=',
            obsidian: 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAFElEQVQ4y2NgGAWjYBSMglEwCkgEABH4AAGAXgBBAAAAAElFTkSuQmCC'
        };

        // Materials cache
        const materialCache = {};
        
        // Preload Minecraft textures
        function loadMinecraftTexture(name) {
            return new Promise(resolve => {
                // Create an Image object
                const img = new Image();
                img.onload = function() {
                    // Create a canvas to draw the image on
                    const canvas = document.createElement('canvas');
                    canvas.width = img.width;
                    canvas.height = img.height;
                    const context = canvas.getContext('2d');
                    context.drawImage(img, 0, 0);
                    
                    // Create a texture from the canvas
                    const texture = new THREE.Texture(canvas);
                    texture.magFilter = THREE.NearestFilter; // Pixelated Minecraft look
                    texture.minFilter = THREE.NearestFilter;
                    texture.generateMipmaps = false;
                    texture.needsUpdate = true;
                    
                    resolve(texture);
                };
                // Use the base64 data
                img.src = textureData[name];
            });
        }
        
        // Create Minecraft block material
        async function createMinecraftMaterial(textureName) {
            if (materialCache[textureName]) return materialCache[textureName];
            
            const texture = await loadMinecraftTexture(textureName);
            const material = new THREE.MeshLambertMaterial({ 
                map: texture, 
                transparent: false
            });
            
            materialCache[textureName] = material;
            return material;
        }
        
        // Create directional material for logs
        async function createLogMaterial() {
            if (materialCache['log']) return materialCache['log'];
            
            const sideTex = await loadMinecraftTexture('oakLog');
            const topTex = await loadMinecraftTexture('oakLogTop');
            
            const materials = [
                new THREE.MeshLambertMaterial({ map: sideTex }), // right
                new THREE.MeshLambertMaterial({ map: sideTex }), // left
                new THREE.MeshLambertMaterial({ map: topTex }),  // top
                new THREE.MeshLambertMaterial({ map: topTex }),  // bottom
                new THREE.MeshLambertMaterial({ map: sideTex }), // front
                new THREE.MeshLambertMaterial({ map: sideTex })  // back
            ];
            
            materialCache['log'] = materials;
            return materials;
        }

        // Lighting system - Minecraft uses simple lighting
        function setupLights() {
            // Directional light for sun
            const sunLight = new THREE.DirectionalLight(0xffffcc, 0.8);
            sunLight.position.set(50, 100, 50);
            sunLight.castShadow = true;
            sunLight.shadow.mapSize.width = 1024;
            sunLight.shadow.mapSize.height = 1024;
            sunLight.shadow.camera.near = 0.5;
            sunLight.shadow.camera.far = 200;
            sunLight.shadow.camera.left = -50;
            sunLight.shadow.camera.right = 50;
            sunLight.shadow.camera.top = 50;
            sunLight.shadow.camera.bottom = -50;
            scene.add(sunLight);
            
            // Ambient light for general illumination
            const ambientLight = new THREE.AmbientLight(0x6688cc, 0.5);
            scene.add(ambientLight);
            
            return { sunLight, ambientLight };
        }

        // Museum structure
        const BLOCK_SIZE = 1; // 1 meter = 1 minecraft block
        
        // Floor heights
        const FLOOR_HEIGHT = 6; // 6 blocks tall per floor
        
        // Museum dimensions
        const MUSEUM_WIDTH = 25;  // blocks
        const MUSEUM_DEPTH = 35;  // blocks
        const FLOORS = 2;         // number of floors
        
        // Building dimensions
        const buildingDimensions = {
            width: MUSEUM_WIDTH * BLOCK_SIZE,
            height: FLOORS * FLOOR_HEIGHT * BLOCK_SIZE,
            depth: MUSEUM_DEPTH * BLOCK_SIZE
        };
        
        // Collision objects - rigid boundaries
        const walls = [];
        
        // Create a Minecraft style block
        async function createBlock(x, y, z, textureName, dimensions = [1, 1, 1], addToCollision = false) {
            const geometry = new THREE.BoxGeometry(
                dimensions[0] * BLOCK_SIZE,
                dimensions[1] * BLOCK_SIZE,
                dimensions[2] * BLOCK_SIZE
            );
            
            let material;
            if (textureName === 'log') {
                material = await createLogMaterial();
            } else {
                material = await createMinecraftMaterial(textureName);
            }
            
            const block = new THREE.Mesh(geometry, material);
            block.position.set(
                x * BLOCK_SIZE + (dimensions[0] * BLOCK_SIZE) / 2,
                y * BLOCK_SIZE + (dimensions[1] * BLOCK_SIZE) / 2,
                z * BLOCK_SIZE + (dimensions[2] * BLOCK_SIZE) / 2
            );
            
            block.castShadow = true;
            block.receiveShadow = true;
            
            scene.add(block);
            
            // Add to collision objects if needed
            if (addToCollision) {
                walls.push({
                    minX: block.position.x - dimensions[0] * BLOCK_SIZE / 2,
                    maxX: block.position.x + dimensions[0] * BLOCK_SIZE / 2,
                    minY: block.position.y - dimensions[1] * BLOCK_SIZE / 2,
                    maxY: block.position.y + dimensions[1] * BLOCK_SIZE / 2,
                    minZ: block.position.z - dimensions[2] * BLOCK_SIZE / 2,
                    maxZ: block.position.z + dimensions[2] * BLOCK_SIZE / 2
                });
            }
            
            return block;
        }
        
        // Create staircase
        async function createStairs(startX, startY, startZ, width, steps, direction, material = 'oakPlanks') {
            const stairGroup = new THREE.Group();
            
            // Direction vectors
            const directions = {
                'north': [0, 0, -1],
                'south': [0, 0, 1],
                'east': [1, 0, 0],
                'west': [-1, 0, 0]
            };
            
            const dir = directions[direction];
            
            // Create each step
            for (let i = 0; i < steps; i++) {
                const stepX = startX + (dir[0] * i);
                const stepY = startY + i;
                const stepZ = startZ + (dir[2] * i);
                
                // Main step block
                const step = await createBlock(
                    stepX, 
                    stepY, 
                    stepZ, 
                    material, 
                    [width, 0.5, 1],
                    true // Add to collision
                );
                
                stairGroup.add(step);
                
                // If not the first step, add a riser
                if (i > 0) {
                    const riserX = stepX;
                    const riserY = stepY - 0.5;
                    const riserZ = stepZ;
                    
                    const riser = await createBlock(
                        riserX, 
                        riserY, 
                        riserZ, 
                        material, 
                        [width, 0.5, 1],
                        true // Add to collision
                    );
                    
                    stairGroup.add(riser);
                }
            }
            
            // Add railings on both sides
            for (let i = 0; i < steps; i++) {
                const railX = startX + (dir[0] * i);
                const railY = startY + i + 1; // 1 block above the step
                const railZ = startZ + (dir[2] * i);
                
                // Left railing post
                const leftPost = await createBlock(
                    railX - (dir[2] * (width/2 - 0.5)), 
                    railY, 
                    railZ + (dir[0] * (width/2 - 0.5)), 
                    'oakLog', 
                    [1, 1, 1],
                    true // Add to collision
                );
                
                // Right railing post
                const rightPost = await createBlock(
                    railX + (dir[2] * (width/2 - 0.5)), 
                    railY, 
                    railZ - (dir[0] * (width/2 - 0.5)), 
                    'oakLog', 
                    [1, 1, 1],
                    true // Add to collision
                );
                
                stairGroup.add(leftPost);
                stairGroup.add(rightPost);
            }
            
            scene.add(stairGroup);
            return stairGroup;
        }
        
        // Create chairs (can be climbed)
        async function createChair(x, y, z, rotation = 0) {
            const chairGroup = new THREE.Group();
            
            // Chair seat
            const seat = await createBlock(x, y, z, 'oakPlanks', [1.5, 0.5, 1.5], true);
            chairGroup.add(seat);
            
            // Chair back
            const back = await createBlock(x, y + 1, z - 0.5, 'birchPlanks', [1.5, 1, 0.5], true);
            chairGroup.add(back);
            
            // Chair legs
            const legPositions = [
                [x - 0.5, y - 0.5, z - 0.5], // front left
                [x + 0.5, y - 0.5, z - 0.5], // front right
                [x - 0.5, y - 0.5, z + 0.5], // back left
                [x + 0.5, y - 0.5, z + 0.5]  // back right
            ];
            
            for (const pos of legPositions) {
                const leg = await createBlock(pos[0], pos[1], pos[2], 'oakLog', [0.5, 0.5, 0.5], true);
                chairGroup.add(leg);
            }
            
            chairGroup.rotation.y = rotation;
            scene.add(chairGroup);
            
            // Add chair to collidable objects for climbing
            collidableObjects.push({
                type: 'chair',
                x: x,
                y: y,
                z: z,
                width: 1.5,
                height: 1.5,
                depth: 1.5,
                climbable: true
            });
            
            return chairGroup;
        }
        
        // Create a Minecraft-style frame for artwork
        async function createArtworkFrame(x, y, z, width, height, depth, rotationY) {
            const frameGroup = new THREE.Group();
            frameGroup.position.set(x, y, z);
            frameGroup.rotation.y = rotationY;
            
            // Frame material (dark oak)
            const frameMaterial = await createMinecraftMaterial('oakLog');
            
            // Create outer frame - using 0.5 block size pieces for detail
            const frameThickness = 0.25;
            
            // Top and bottom
            const topBar = new THREE.Mesh(
                new THREE.BoxGeometry(width + frameThickness, frameThickness, depth),
                frameMaterial
            );
            topBar.position.y = height/2;
            frameGroup.add(topBar);
            
            const bottomBar = new THREE.Mesh(
                new THREE.BoxGeometry(width + frameThickness, frameThickness, depth),
                frameMaterial
            );
            bottomBar.position.y = -height/2;
            frameGroup.add(bottomBar);
            
            // Left and right
            const leftBar = new THREE.Mesh(
                new THREE.BoxGeometry(frameThickness, height + frameThickness, depth),
                frameMaterial
            );
            leftBar.position.x = -width/2;
            frameGroup.add(leftBar);
            
            const rightBar = new THREE.Mesh(
                new THREE.BoxGeometry(frameThickness, height + frameThickness, depth),
                frameMaterial
            );
            rightBar.position.x = width/2;
            frameGroup.add(rightBar);
            
            // Back board
            const backBoard = new THREE.Mesh(
                new THREE.BoxGeometry(width, height, 0.1),
                await createMinecraftMaterial('birchPlanks')
            );
            backBoard.position.z = -0.1;
            frameGroup.add(backBoard);
            
            scene.add(frameGroup);
            return frameGroup;
        }

        // Create a painting within a frame
        async function createPainting(config) {
            const { imageUrl, x, y, z, rotationY, width, height, title, artist, description } = config;
            
            // Create frame
            const frame = await createArtworkFrame(
                x, y, z, 
                width || 3, 
                height || 2, 
                0.4, 
                rotationY
            );
            
            // Load image
            textureLoader.load(imageUrl, (texture) => {
                // Use nearest filter for pixelated look
                texture.magFilter = THREE.NearestFilter;
                texture.minFilter = THREE.NearestFilter;
                
                const paintingMaterial = new THREE.MeshBasicMaterial({ 
                    map: texture,
                    transparent: false
                });
                
                const painting = new THREE.Mesh(
                    new THREE.PlaneGeometry(width || 3, height || 2),
                    paintingMaterial
                );
                
                // Position slightly in front of frame
                painting.position.z = 0.1;
                frame.add(painting);
                
                // Add to interactable objects for customization
                interactableObjects.push({
                    object: painting,
                    frame: frame,
                    config: {
                        imageUrl,
                        title: title || 'Untitled',
                        artist: artist || 'Unknown Artist',
                        description: description || 'No description available.'
                    }
                });
                
                // Add collision box for the frame
                walls.push({
                    minX: frame.position.x - (width || 3)/2 - 0.2,
                    maxX: frame.position.x + (width || 3)/2 + 0.2,
                    minY: frame.position.y - (height || 2)/2 - 0.2,
                    maxY: frame.position.y + (height || 2)/2 + 0.2,
                    minZ: frame.position.z - 0.4,
                    maxZ: frame.position.z + 0.4,
                    isFrame: true,
                    rotation: rotationY
                });
            });
            
            return frame;
        }
        
        // Create a glowstone light
        async function createLight(x, y, z) {
            const light = await createBlock(x, y, z, 'glowstone', [1, 1, 1]);
            
            // Add point light
            const pointLight = new THREE.PointLight(0xffffaa, 1, 10);
            pointLight.position.set(x + 0.5, y + 0.5, z + 0.5);
            scene.add(pointLight);
            
            return { block: light, light: pointLight };
        }
        
        // Build museum structure with rigid boundaries
        async function buildMuseum() {
            // Build walls and floors
            
            // Ground floor
            for (let x = 0; x < MUSEUM_WIDTH; x++) {
                for (let z = 0; z < MUSEUM_DEPTH; z++) {
                    // Floor
                    await createBlock(x - MUSEUM_WIDTH/2, 0, z - MUSEUM_DEPTH/2, 'polishedAndesite');
                    
                    // Walls - use obsidian for more rigid boundary
                    if (x === 0 || x === MUSEUM_WIDTH - 1 || z === 0 || z === MUSEUM_DEPTH - 1) {
                        for (let y = 1; y < FLOOR_HEIGHT; y++) {
                            // Skip wall where doors will be
                            if (!(z === 0 && x >= MUSEUM_WIDTH/2 - 2 && x <= MUSEUM_WIDTH/2 + 1)) {
                                const material = (x === 0 || x === MUSEUM_WIDTH - 1 || z === 0 || z === MUSEUM_DEPTH - 1) ? 'obsidian' : 'stoneBricks';
                                await createBlock(x - MUSEUM_WIDTH/2, y, z - MUSEUM_DEPTH/2, material, [1, 1, 1], true);
                            }
                        }
                    }
                }
            }
            
            // Second floor
            for (let x = 0; x < MUSEUM_WIDTH; x++) {
                for (let z = 0; z < MUSEUM_DEPTH; z++) {
                    // Floor/Ceiling
                    await createBlock(x - MUSEUM_WIDTH/2, FLOOR_HEIGHT, z - MUSEUM_DEPTH/2, 'oakPlanks');
                    
                    // Second floor walls - use obsidian for boundaries
                    if (x === 0 || x === MUSEUM_WIDTH - 1 || z === 0 || z === MUSEUM_DEPTH - 1) {
                        for (let y = FLOOR_HEIGHT + 1; y < FLOOR_HEIGHT * 2; y++) {
                            const material = (x === 0 || x === MUSEUM_WIDTH - 1 || z === 0 || z === MUSEUM_DEPTH - 1) ? 'obsidian' : 'stoneBricks';
                            await createBlock(x - MUSEUM_WIDTH/2, y, z - MUSEUM_DEPTH/2, material, [1, 1, 1], true);
                        }
                    }
                }
            }
            
            // Roof
            for (let x = 0; x < MUSEUM_WIDTH; x++) {
                for (let z = 0; z < MUSEUM_DEPTH; z++) {
                    await createBlock(x - MUSEUM_WIDTH/2, FLOOR_HEIGHT * 2, z - MUSEUM_DEPTH/2, 'oakPlanks');
                }
            }
            
            // Create staircase from first to second floor - positioned away from paintings
            await createStairs(
                -MUSEUM_WIDTH/4, // X position
                1,               // Start Y (above floor)
                -MUSEUM_DEPTH/4, // Z position
                3,               // Width
                FLOOR_HEIGHT-1,  // Number of steps
                'north',         // Direction
                'birchPlanks'    // Material
            );
            
            // Create first floor lights
            for (let x = 5; x < MUSEUM_WIDTH; x += 5) {
                for (let z = 5; z < MUSEUM_DEPTH; z += 5) {
                    await createLight(x - MUSEUM_WIDTH/2, FLOOR_HEIGHT - 1, z - MUSEUM_DEPTH/2);
                }
            }
            
            // Create second floor lights
            for (let x = 5; x < MUSEUM_WIDTH; x += 5) {
                for (let z = 5; z < MUSEUM_DEPTH; z += 5) {
                    await createLight(x - MUSEUM_WIDTH/2, FLOOR_HEIGHT * 2 - 1, z - MUSEUM_DEPTH/2);
                }
            }
            
            // Create chairs on first floor - for climbing
            await createChair(-5, 1, -10, 0);
            await createChair(0, 1, -10, 0);
            await createChair(5, 1, -10, 0);
            
            await createChair(-5, 1, 5, Math.PI);
            await createChair(0, 1, 5, Math.PI);
            await createChair(5, 1, 5, Math.PI);
            
            // Create chairs on second floor
            await createChair(-5, FLOOR_HEIGHT + 1, -10, 0);
            await createChair(0, FLOOR_HEIGHT + 1, -10, 0);
            await createChair(5, FLOOR_HEIGHT + 1, -10, 0);
        }
        
        // Gallery layout - more paintings with reliable image links
        const paintingConfigs = [
            // First floor - North Wall (front)
            {
                imageUrl: "https://cdn.jsdelivr.net/gh/mcbeeringi/assets/img/mc/starry_night.jpg", // Starry Night placeholder
                x: -8,
                y: 3,
                z: -MUSEUM_DEPTH/2 + 0.5,
                rotationY: 0,
                width: 4,
                height: 3,
                title: "Starry Night",
                artist: "Vincent van Gogh",
                description: "A night sky filled with swirling clouds and bright stars."
            },
            {
                imageUrl: "https://cdn.jsdelivr.net/gh/mcbeeringi/assets/img/mc/mona_lisa.jpg", // Mona Lisa placeholder
                x: -3,
                y: 3,
                z: -MUSEUM_DEPTH/2 + 0.5,
                rotationY: 0,
                width: 2.5,
                height: 3.5,
                title: "Mona Lisa",
                artist: "Leonardo da Vinci",
                description: "One of the most famous portraits ever painted."
            },
            {
                imageUrl: "https://cdn.jsdelivr.net/gh/mcbeeringi/assets/img/mc/van_gogh_self_portrait.jpg", // Van Gogh Self Portrait placeholder
                x: 2,
                y: 3,
                z: -MUSEUM_DEPTH/2 + 0.5,
                rotationY: 0,
                width: 3,
                height: 3.5,
                title: "Self-Portrait",
                artist: "Vincent van Gogh",
                description: "Van Gogh's self-portrait with intense eyes and red beard."
            },
            {
                imageUrl: "https://cdn.jsdelivr.net/gh/mcbeeringi/assets/img/mc/the_great_wave_off_kanagawa.jpg", // The Great Wave placeholder
                x: 7,
                y: 3,
                z: -MUSEUM_DEPTH/2 + 0.5,
                rotationY: 0,
                width: 4,
                height: 3,
                title: "The Great Wave off Kanagawa",
                artist: "Hokusai",
                description: "A massive wave threatens boats off the coast of Kanagawa."
            },
            
            // First floor - East Wall (right)
            {
                imageUrl: "https://cdn.jsdelivr.net/gh/mcbeeringi/assets/img/mc/composition_with_red_blue_and_yellow.jpg", // Mondrian placeholder
                x: MUSEUM_WIDTH/2 - 0.5,
                y: 3,
                z: -8,
                rotationY: Math.PI/2,
                width: 3,
                height: 3,
                title: "Composition with Red, Blue and Yellow",
                artist: "Piet Mondrian",
                description: "Abstract painting with geometric primary colors."
            },
            {
                imageUrl: "https://cdn.jsdelivr.net/gh/mcbeeringi/assets/img/mc/american_gothic.jpg", // American Gothic placeholder
                x: MUSEUM_WIDTH/2 - 0.5,
                y: 3,
                z: -3,
                rotationY: Math.PI/2,
                width: 3,
                height: 4,
                title: "American Gothic",
                artist: "Grant Wood",
                description: "A farmer and his daughter standing in front of their house."
            },
            {
                imageUrl: "https://cdn.jsdelivr.net/gh/mcbeeringi/assets/img/mc/girl_with_a_pearl_earring.jpg", // Girl with a Pearl Earring placeholder
                x: MUSEUM_WIDTH/2 - 0.5,
                y: 3,
                z: 2,
                rotationY: Math.PI/2,
                width: 2.5,
                height: 3,
                title: "Girl with a Pearl Earring",
                artist: "Johannes Vermeer",
                description: "A girl wearing an exotic dress and a pearl earring."
            },
            {
                imageUrl: "https://cdn.jsdelivr.net/gh/mcbeeringi/assets/img/mc/the_scream.jpg", // The Scream placeholder
                x: MUSEUM_WIDTH/2 - 0.5,
                y: 3,
                z: 7,
                rotationY: Math.PI/2,
                width: 3,
                height: 4,
                title: "The Scream",
                artist: "Edvard Munch",
                description: "An agonized figure against a blood-red sky."
            },
            
            // First floor - South Wall (back)
            {
                imageUrl: "https://cdn.jsdelivr.net/gh/mcbeeringi/assets/img/mc/the_persistence_of_memory.jpg", // The Persistence of Memory placeholder
                x: -8,
                y: 3,
                z: MUSEUM_DEPTH/2 - 0.5,
                rotationY: Math.PI,
                width: 4,
                height: 3,
                title: "The Persistence of Memory",
                artist: "Salvador Dalí",
                description: "Melting clocks in a surreal landscape."
            },
            {
                imageUrl: "https://cdn.jsdelivr.net/gh/mcbeeringi/assets/img/mc/the_birth_of_venus.jpg", // The Birth of Venus placeholder
                x: -3,
                y: 3,
                z: MUSEUM_DEPTH/2 - 0.5,
                rotationY: Math.PI,
                width: 5,
                height: 3,
                title: "The Birth of Venus",
                artist: "Sandro Botticelli",
                description: "Venus emerges from the sea on a shell."
            },
            {
                imageUrl: "https://cdn.jsdelivr.net/gh/mcbeeringi/assets/img/mc/the_night_watch.jpg", // The Night Watch placeholder
                x: 3,
                y: 3,
                z: MUSEUM_DEPTH/2 - 0.5,
                rotationY: Math.PI,
                width: 5,
                height: 4,
                title: "The Night Watch",
                artist: "Rembrandt",
                description: "A company of militia moving out."
            },
            {
                imageUrl: "https://cdn.jsdelivr.net/gh/mcbeeringi/assets/img/mc/guernica.jpg", // Guernica placeholder
                x: 10,
                y: 3,
                z: MUSEUM_DEPTH/2 - 0.5,
                rotationY: Math.PI,
                width: 8,
                height: 3.5,
                title: "Guernica",
                artist: "Pablo Picasso",
                description: "A powerful statement against the tragedies of war."
            },
            
            // First floor - West Wall (left)
            {
                imageUrl: "https://cdn.jsdelivr.net/gh/mcbeeringi/assets/img/mc/water_lilies.jpg", // Water Lilies placeholder
                x: -MUSEUM_WIDTH/2 + 0.5,
                y: 3,
                z: -8,
                rotationY: -Math.PI/2,
                width: 5,
                height: 3,
                title: "Water Lilies",
                artist: "Claude Monet",
                description: "Serene scene of water lilies from Monet's garden."
            },
            {
                imageUrl: "https://cdn.jsdelivr.net/gh/mcbeeringi/assets/img/mc/a_sunday_on_la_grande_jatte.jpg", // A Sunday on La Grande Jatte placeholder
                x: -MUSEUM_WIDTH/2 + 0.5,
                y: 3,
                z: -2,
                rotationY: -Math.PI/2,
                width: 5,
                height: 3,
                title: "A Sunday on La Grande Jatte",
                artist: "Georges Seurat",
                description: "People relaxing in a suburban park using pointillism technique."
            },
            {
                imageUrl: "https://cdn.jsdelivr.net/gh/mcbeeringi/assets/img/mc/nighthawks.jpg", // Nighthawks placeholder
                x: -MUSEUM_WIDTH/2 + 0.5,
                y: 3,
                z: 4,
                rotationY: -Math.PI/2,
                width: 5,
                height: 2.5,
                title: "Nighthawks",
                artist: "Edward Hopper",
                description: "People in a downtown diner late at night."
            },
            {
                imageUrl: "https://cdn.jsdelivr.net/gh/mcbeeringi/assets/img/mc/the_creation_of_adam.jpg", // The Creation of Adam placeholder
                x: -MUSEUM_WIDTH/2 + 0.5,
                y: 3,
                z: 10,
                rotationY: -Math.PI/2,
                width: 6,
                height: 3,
                title: "The Creation of Adam",
                artist: "Michelangelo",
                description: "God giving life to Adam, part of the Sistine Chapel ceiling."
            },
            
            // Second floor - North Wall
            {
                imageUrl: "https://cdn.jsdelivr.net/gh/mcbeeringi/assets/img/mc/campbells_soup_can.jpg", // Campbell's Soup Can placeholder
                x: -8,
                y: FLOOR_HEIGHT + 3,
                z: -MUSEUM_DEPTH/2 + 0.5,
                rotationY: 0,
                width: 2.5,
                height: 3.5,
                title: "Campbell's Soup Can",
                artist: "Andy Warhol",
                description: "Iconic pop art representation of a soup can."
            },
            {
                imageUrl: "https://cdn.jsdelivr.net/gh/mcbeeringi/assets/img/mc/the_son_of_man.jpg", // The Son of Man placeholder
                x: -4,
                y: FLOOR_HEIGHT + 3,
                z: -MUSEUM_DEPTH/2 + 0.5,
                rotationY: 0,
                width: 2.5,
                height: 3.5,
                title: "The Son of Man",
                artist: "René Magritte",
                description: "A man in a suit with an apple obscuring his face."
            },
            {
                imageUrl: "https://cdn.jsdelivr.net/gh/mcbeeringi/assets/img/mc/the_kiss.jpg", // The Kiss placeholder
                x: 0,
                y: FLOOR_HEIGHT + 3,
                z: -MUSEUM_DEPTH/2 + 0.5,
                rotationY: 0,
                width: 3,
                height: 4,
                title: "The Kiss",
                artist: "Gustav Klimt",
                description: "A couple embracing, in Klimt's distinctive golden style."
            },
            {
                imageUrl: "https://cdn.jsdelivr.net/gh/mcbeeringi/assets/img/mc/the_last_supper.jpg", // The Last Supper placeholder
                x: 5,
                y: FLOOR_HEIGHT + 3,
                z: -MUSEUM_DEPTH/2 + 0.5,
                rotationY: 0,
                width: 6,
                height: 3,
                title: "The Last Supper",
                artist: "Leonardo da Vinci",
                description: "Jesus and his disciples at their final meal."
            },
            
            // Second floor - East Wall
            {
                imageUrl: "https://cdn.jsdelivr.net/gh/mcbeeringi/assets/img/mc/the_swing.jpg", // The Swing placeholder
                x: MUSEUM_WIDTH/2 - 0.5,
                y: FLOOR_HEIGHT + 3,
                z: -8,
                rotationY: Math.PI/2,
                width: 3,
                height: 4,
                title: "The Swing",
                artist: "Jean-Honoré Fragonard",
                description: "A young woman on a swing in a lush garden."
            },
            {
                imageUrl: "https://cdn.jsdelivr.net/gh/mcbeeringi/assets/img/mc/dogs_playing_poker.jpg", // Dogs Playing Poker placeholder
                x: MUSEUM_WIDTH/2 - 0.5,
                y: FLOOR_HEIGHT + 3,
                z: -2,
                rotationY: Math.PI/2,
                width: 4,
                height: 3,
                title: "Dogs Playing Poker",
                artist: "Cassius Marcellus Coolidge",
                description: "Anthropomorphized dogs playing poker around a table."
            },
            {
                imageUrl: "https://cdn.jsdelivr.net/gh/mcbeeringi/assets/img/mc/a_friend_in_need.jpg", // A Friend in Need placeholder
                x: MUSEUM_WIDTH/2 - 0.5,
                y: FLOOR_HEIGHT + 3,
                z: 4,
                rotationY: Math.PI/2,
                width: 4,
                height: 3,
                title: "A Friend in Need",
                artist: "Cassius Marcellus Coolidge",
                description: "Part of the Dogs Playing Poker series."
            },
            
            // Second floor - South Wall
            {
                imageUrl: "https://cdn.jsdelivr.net/gh/mcbeeringi/assets/img/mc/the_garden_of_earthly_delights.jpg", // The Garden of Earthly Delights placeholder
                x: -8,
                y: FLOOR_HEIGHT + 3,
                z: MUSEUM_DEPTH/2 - 0.5,
                rotationY: Math.PI,
                width: 6,
                height: 3.5,
                title: "The Garden of Earthly Delights",
                artist: "Hieronymus Bosch",
                description: "Triptych of fantastical, bizarre imagery."
            },
            {
                imageUrl: "https://cdn.jsdelivr.net/gh/mcbeeringi/assets/img/mc/impression_sunrise.jpg", // Impression, Sunrise placeholder
                x: -1,
                y: FLOOR_HEIGHT + 3,
                z: MUSEUM_DEPTH/2 - 0.5,
                rotationY: Math.PI,
                width: 4,
                height: 3,
                title: "Impression, Sunrise",
                artist: "Claude Monet",
                description: "The painting that gave Impressionism its name."
            },
            {
                imageUrl: "https://cdn.jsdelivr.net/gh/mcbeeringi/assets/img/mc/cafe_terrace_at_night.jpg", // Café Terrace at Night placeholder
                x: 5,
                y: FLOOR_HEIGHT + 3,
                z: MUSEUM_DEPTH/2 - 0.5,
                rotationY: Math.PI,
                width: 3,
                height: 4,
                title: "Café Terrace at Night",
                artist: "Vincent van Gogh",
                description: "A café in Arles, France, painted at night."
            },
            {
                imageUrl: "https://cdn.jsdelivr.net/gh/mcbeeringi/assets/img/mc/les_demoiselles_d_avignon.jpg", // Les Demoiselles d'Avignon placeholder
                x: 10,
                y: FLOOR_HEIGHT + 3,
                z: MUSEUM_DEPTH/2 - 0.5,
                rotationY: Math.PI,
                width: 4,
                height: 4,
                title: "Les Demoiselles d'Avignon",
                artist: "Pablo Picasso",
                description: "Five nude female prostitutes from Barcelona, a pioneering work of Cubism."
            },
            
            // Second floor - West Wall
            {
                imageUrl: "https://cdn.jsdelivr.net/gh/mcbeeringi/assets/img/mc/christinas_world.jpg", // Christina's World placeholder
                x: -MUSEUM_WIDTH/2 + 0.5,
                y: FLOOR_HEIGHT + 3,
                z: -8,
                rotationY: -Math.PI/2,
                width: 4.5,
                height: 3,
                title: "Christina's World",
                artist: "Andrew Wyeth",
                description: "A woman crawling across a field toward a house in the distance."
            },
            {
                imageUrl: "https://cdn.jsdelivr.net/gh/mcbeeringi/assets/img/mc/wanderer_above_the_sea_of_fog.jpg", // Wanderer above the Sea of Fog placeholder
                x: -MUSEUM_WIDTH/2 + 0.5,
                y: FLOOR_HEIGHT + 3,
                z: -2,
                rotationY: -Math.PI/2,
                width: 3,
                height: 4,
                title: "Wanderer above the Sea of Fog",
                artist: "Caspar David Friedrich",
                description: "A man standing on a mountain overlooking a sea of fog."
            },
            {
                imageUrl: "https://cdn.jsdelivr.net/gh/mcbeeringi/assets/img/mc/the_treachery_of_images.jpg", // The Treachery of Images placeholder
                x: -MUSEUM_WIDTH/2 + 0.5,
                y: FLOOR_HEIGHT + 3,
                z: 4,
                rotationY: -Math.PI/2,
                width: 4,
                height: 3,
                title: "The Treachery of Images",
                artist: "René Magritte",
                description: "A painting of a pipe with the caption 'This is not a pipe.'"
            },
            {
                imageUrl: "https://cdn.jsdelivr.net/gh/mcbeeringi/assets/img/mc/minecraft_steve.jpg", // Minecraft Steve placeholder
                x: -MUSEUM_WIDTH/2 + 0.5,
                y: FLOOR_HEIGHT + 3,
                z: 10,
                rotationY: -Math.PI/2,
                width: 3,
                height: 3,
                title: "Steve",
                artist: "Mojang",
                description: "The iconic protagonist of Minecraft."
            }
        ];

        // Physics and collision detection
        const PLAYER_HEIGHT = 1.7;
        const PLAYER_RADIUS = 0.3;
        const GRAVITY = 20.0;
        const JUMP_FORCE = 7.0;
        
        let canJump = true;
        let isCrouching = false;
        const velocity = new THREE.Vector3();
        const direction = new THREE.Vector3();
        let moveSpeed = 5.0;
        let runMultiplier = 1.6;
        
        // Collectible objects for collision detection
        const collidableObjects = [];
        const interactableObjects = [];
        
        // First-person controls with improved camera
        let moveForward = false;
        let moveBackward = false;
        let moveLeft = false;
        let moveRight = false;
        let isRunning = false;
        let isJumping = false;
        
        let prevTime = performance.now();
        
        // Input handling
        const onKeyDown = function(event) {
            switch(event.code) {
                case 'KeyW': moveForward = true; break;
                case 'KeyS': moveBackward = true; break;
                case 'KeyA': moveLeft = true; break;
                case 'KeyD': moveRight = true; break;
                case 'ShiftLeft': 
                case 'ShiftRight': 
                    isRunning = true; 
                    break;
                case 'Space': 
                    if (canJump) {
                        velocity.y = JUMP_FORCE;
                        canJump = false;
                    }
                    break;
                case 'KeyE':
                    toggleCustomizer();
                    break;
                case 'KeyC':
                    isCrouching = !isCrouching;
                    if (isCrouching) {
                        camera.position.y = PLAYER_HEIGHT * 0.6;
                        moveSpeed = 2.0;
                    } else {
                        camera.position.y = PLAYER_HEIGHT;
                        moveSpeed = 5.0;
                    }
                    break;
            }
        };

        const onKeyUp = function(event) {
            switch(event.code) {
                case 'KeyW': moveForward = false; break;
                case 'KeyS': moveBackward = false; break;
                case 'KeyA': moveLeft = false; break;
                case 'KeyD': moveRight = false; break;
                case 'ShiftLeft': 
                case 'ShiftRight': 
                    isRunning = false; 
                    break;
            }
        };

        document.addEventListener('keydown', onKeyDown);
        document.addEventListener('keyup', onKeyUp);

        // First-person camera with improved controls
        const euler = new THREE.Euler(0, 0, 0, 'YXZ');
        const lookDirection = new THREE.Vector3();
        const pitchObject = new THREE.Object3D();
        const yawObject = new THREE.Object3D();
        let isLocked = false;
        
        yawObject.add(pitchObject);
        pitchObject.add(camera);
        scene.add(yawObject);
        
        // Mouse look handling
        document.addEventListener('click', () => {
            document.body.requestPointerLock();
        });

        document.addEventListener('pointerlockchange', () => {
            isLocked = document.pointerLockElement === document.body;
            if (isLocked) {
                document.getElementById('instructions').style.opacity = '0.5';
            } else {
                document.getElementById('instructions').style.opacity = '1';
                document.getElementById('customizer').style.display = 'none';
            }
        });

        document.addEventListener('mousemove', (event) => {
            if (isLocked) {
                const movementX = event.movementX || 0;
                const movementY = event.movementY || 0;
                
                // Rotate yaw object (horizontal)
                yawObject.rotation.y -= movementX * 0.002;
                
                // Rotate pitch object (vertical)
                pitchObject.rotation.x -= movementY * 0.002;
                
                // Limit pitch to avoid gimbal lock
                pitchObject.rotation.x = Math.max(-Math.PI/2 + 0.01, Math.min(Math.PI/2 - 0.01, pitchObject.rotation.x));
            }
        });

        // Rigid collision detection for walls and objects
        function checkCollision(position, radius) {
            // Check for wall collisions (precise bounds)
            for (const wall of walls) {
                // Special handling for frames based on rotation
                if (wall.isFrame) {
                    // Create a buffer around the frame based on rotation
                    let boxMinX = wall.minX;
                    let boxMaxX = wall.maxX;
                    let boxMinZ = wall.minZ;
                    let boxMaxZ = wall.maxZ;
                    
                    // Expand collision box depending on orientation
                    if (Math.abs(wall.rotation) < 0.1 || Math.abs(wall.rotation - Math.PI) < 0.1) {
                        // North-South facing frames
                        boxMinZ -= 0.5; // Expand Z collision space
                        boxMaxZ += 0.5;
                    } else {
                        // East-West facing frames
                        boxMinX -= 0.5; // Expand X collision space
                        boxMaxX += 0.5;
                    }
                    
                    // Check if player is inside expanded frame bounds
                    if (position.x >= boxMinX && position.x <= boxMaxX &&
                        position.y >= wall.minY && position.y <= wall.maxY &&
                        position.z >= boxMinZ && position.z <= boxMaxZ) {
                        
                        // Push player out of the collision
                        if (Math.abs(wall.rotation) < 0.1) {
                            // North wall frame
                            position.z = boxMaxZ + radius;
                        } else if (Math.abs(wall.rotation - Math.PI) < 0.1) {
                            // South wall frame
                            position.z = boxMinZ - radius;
                        } else if (Math.abs(wall.rotation - Math.PI/2) < 0.1) {
                            // East wall frame
                            position.x = boxMinX - radius;
                        } else {
                            // West wall frame
                            position.x = boxMaxX + radius;
                        }
                        return true; // Collision occurred
                    }
                } else {
                    // Regular wall collision (box)
                    if (position.x >= wall.minX - radius && position.x <= wall.maxX + radius &&
                        position.y >= wall.minY && position.y <= wall.maxY &&
                        position.z >= wall.minZ - radius && position.z <= wall.maxZ + radius) {
                        
                        // Find closest face to push out from
                        const distToMinX = Math.abs(position.x - (wall.minX - radius));
                        const distToMaxX = Math.abs(position.x - (wall.maxX + radius));
                        const distToMinZ = Math.abs(position.z - (wall.minZ - radius));
                        const distToMaxZ = Math.abs(position.z - (wall.maxZ + radius));
                        
                        // Find the minimum distance
                        const minDist = Math.min(distToMinX, distToMaxX, distToMinZ, distToMaxZ);
                        
                        // Push out in the direction of minimum distance
                        if (minDist === distToMinX) position.x = wall.minX - radius;
                        else if (minDist === distToMaxX) position.x = wall.maxX + radius;
                        else if (minDist === distToMinZ) position.z = wall.minZ - radius;
                        else if (minDist === distToMaxZ) position.z = wall.maxZ + radius;
                        
                        return true; // Collision occurred
                    }
                }
            }
            
            // Hard museum boundary checks
            const halfWidth = MUSEUM_WIDTH * BLOCK_SIZE / 2;
            const halfDepth = MUSEUM_DEPTH * BLOCK_SIZE / 2;
            
            let collided = false;
            
            // Enforce rigid boundaries
            if (position.x < -halfWidth + radius) {
                position.x = -halfWidth + radius;
                collided = true;
            }
            if (position.x > halfWidth - radius) {
                position.x = halfWidth - radius;
                collided = true;
            }
            if (position.z < -halfDepth + radius) {
                position.z = -halfDepth + radius;
                collided = true;
            }
            if (position.z > halfDepth - radius) {
                position.z = halfDepth - radius;
                collided = true;
            }
            
            // Check for collisions with chairs and other objects (for climbing)
            for (const obj of collidableObjects) {
                if (obj.type === 'chair') {
                    const chairX = obj.x * BLOCK_SIZE;
                    const chairY = obj.y * BLOCK_SIZE;
                    const chairZ = obj.z * BLOCK_SIZE;
                    const chairWidth = obj.width * BLOCK_SIZE / 2;
                    const chairDepth = obj.depth * BLOCK_SIZE / 2;
                    
                    // Check if player is on top of chair
                    if (position.x >= chairX - chairWidth && position.x <= chairX + chairWidth &&
                        position.z >= chairZ - chairDepth && position.z <= chairZ + chairDepth &&
                        yawObject.position.y <= chairY + obj.height * BLOCK_SIZE &&
                        yawObject.position.y >= chairY) {
                        
                        // Player is on chair, set Y position
                        if (velocity.y <= 0) {
                            yawObject.position.y = chairY + obj.height * BLOCK_SIZE;
                            velocity.y = 0;
                            canJump = true;
                            return true;
                        }
                    }
                }
            }
            
            return collided;
        }
        
        // Check which painting the player is looking at
        function checkPaintingInteraction() {
            // Create raycaster from camera
            const raycaster = new THREE.Raycaster();
            raycaster.setFromCamera(new THREE.Vector2(0, 0), camera);
            
            // Get objects the ray intersects
            const intersects = [];
            for (const obj of interactableObjects) {
                const intersect = raycaster.intersectObject(obj.object);
                if (intersect.length > 0) {
                    intersects.push({
                        distance: intersect[0].distance,
                        object: obj
                    });
                }
            }
            
            // Sort by distance
            intersects.sort((a, b) => a.distance - b.distance);
            
            // Update UI based on what player is looking at
            if (intersects.length > 0 && intersects[0].distance < 5) {
                const target = intersects[0].object;
                
                // Display painting info
                const config = target.config;
                const info = document.getElementById('roomInfo');
                info.innerHTML = `
                    <strong>${config.title}</strong><br>
                    ${config.artist}<br>
                    ${config.description}
                `;
                info.style.opacity = '1';
                
                // Store currently viewed painting for customizer
                window.currentPainting = target;
                
                document.getElementById('imageUrl').value = config.imageUrl;
                document.getElementById('imageTitle').value = config.title;
                document.getElementById('imageArtist').value = config.artist;
                
                return true;
            } else {
                document.getElementById('roomInfo').style.opacity = '0';
                window.currentPainting = null;
                return false;
            }
        }
        
        // Toggle image customizer panel
        function toggleCustomizer() {
            const customizer = document.getElementById('customizer');
            if (window.currentPainting) {
                customizer.style.display = customizer.style.display === 'none' ? 'block' : 'none';
            } else {
                customizer.style.display = 'none';
                alert('Look at a painting first to customize it.');
            }
        }
        
        // Update painting with new image
        function updatePainting(imageUrl, title, artist) {
            if (!window.currentPainting) return;
            
            const painting = window.currentPainting;
            const config = painting.config;
            
            // Update config
            config.imageUrl = imageUrl;
            config.title = title;
            config.artist = artist;
            
            // Update texture
            textureLoader.load(imageUrl, (texture) => {
                texture.magFilter = THREE.NearestFilter;
                texture.minFilter = THREE.NearestFilter;
                
                // Update the material
                painting.object.material.map = texture;
                painting.object.material.needsUpdate = true;
                
                // Show confirmation
                const info = document.getElementById('roomInfo');
                info.innerHTML = `
                    <strong>Painting Updated!</strong><br>
                    ${title}<br>
                    ${artist}
                `;
                info.style.opacity = '1';
                
                // Hide after 3 seconds
                setTimeout(() => {
                    info.style.opacity = '0';
                }, 3000);
            });
        }
        
        // Set up customizer button
        document.getElementById('updateImage').addEventListener('click', () => {
            const imageUrl = document.getElementById('imageUrl').value;
            const title = document.getElementById('imageTitle').value;
            const artist = document.getElementById('imageArtist').value;
            
            updatePainting(imageUrl, title, artist);
            document.getElementById('customizer').style.display = 'none';
        });

        // Animation loop with physics
        function animate() {
            requestAnimationFrame(animate);
            
            const time = performance.now();
            const delta = Math.min(0.1, (time - prevTime) / 1000); // Cap delta time
            
            if (isLocked) {
                // Calculate movement direction
                direction.z = Number(moveForward) - Number(moveBackward);
                direction.x = Number(moveRight) - Number(moveLeft);
                direction.normalize();
                
                // Apply friction to horizontal movement
                velocity.x -= velocity.x * 10.0 * delta;
                velocity.z -= velocity.z * 10.0 * delta;
                
                // Apply gravity
                velocity.y -= GRAVITY * delta;
                
                // Get movement speed based on run/crouch state
                const currentSpeed = isRunning ? moveSpeed * runMultiplier : moveSpeed;
                
                // Calculate movement vector based on current facing direction
                if (moveForward || moveBackward || moveLeft || moveRight) {
                    // Get the sine and cosine of the yaw angle
                    const angle = yawObject.rotation.y;
                    const sin = Math.sin(angle);
                    const cos = Math.cos(angle);
                    
                    // Calculate velocity based on WASD input
                    velocity.z = direction.z * currentSpeed;
                    velocity.x = direction.x * currentSpeed;
                    
                    // Apply rotation to velocity
                    const vx = velocity.x;
                    const vz = velocity.z;
                    
                    velocity.x = vx * cos - vz * sin;
                    velocity.z = vz * cos + vx * sin;
                }
                
                // Create a copy of position for collision testing
                const nextPosition = yawObject.position.clone();
                nextPosition.x += velocity.x * delta;
                nextPosition.z += velocity.z * delta;
                
                // Check for collisions with rigid boundaries
                const collision = checkCollision(nextPosition, PLAYER_RADIUS);
                
                // Update position if no collision, otherwise velocity is already zeroed
                if (!collision) {
                    yawObject.position.x = nextPosition.x;
                    yawObject.position.z = nextPosition.z;
                } else {
                    // Reset horizontal velocity on collision
                    velocity.x = 0;
                    velocity.z = 0;
                }
                
                // Update vertical position (jumping/gravity)
                yawObject.position.y += velocity.y * delta;
                
                // Floor collision
                if (yawObject.position.y < PLAYER_HEIGHT) {
                    velocity.y = 0;
                    yawObject.position.y = PLAYER_HEIGHT;
                    canJump = true;
                }
                
                // Second floor collision
                if (yawObject.position.y > FLOOR_HEIGHT - 0.5 && 
                    yawObject.position.y < FLOOR_HEIGHT + 0.5 && 
                    velocity.y < 0) {
                    // Check if player is above the second floor area
                    if (Math.abs(yawObject.position.x) < MUSEUM_WIDTH/2 - 1 && 
                        Math.abs(yawObject.position.z) < MUSEUM_DEPTH/2 - 1) {
                        velocity.y = 0;
                        yawObject.position.y = FLOOR_HEIGHT;
                        canJump = true;
                    }
                }
                
                // Ceiling collision (top of the museum)
                if (yawObject.position.y > FLOOR_HEIGHT * FLOORS - 0.5) {
                    velocity.y = 0;
                    yawObject.position.y = FLOOR_HEIGHT * FLOORS - 0.5;
                }
                
                // Check for painting interaction
                checkPaintingInteraction();
            }
            
            renderer.render(scene, camera);
            prevTime = time;
        }

        // Setup the scene
        async function init() {
            // Setup lighting
            setupLights();
            
            // Build the museum
            await buildMuseum();
            
            // Add paintings
            for (const config of paintingConfigs) {
                await createPainting(config);
            }
            
            // Set initial position
            yawObject.position.set(0, PLAYER_HEIGHT, MUSEUM_DEPTH/2 - 5);
            
            // Handle window resize
            window.addEventListener('resize', onWindowResize, false);
            
            // Start animation loop
            animate();
        }

        function onWindowResize() {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        }

        // Add a floor indicator
        function addFloorIndicator() {
            const floorIndicator = document.createElement('div');
            floorIndicator.id = 'floorIndicator';
            floorIndicator.style.position = 'fixed';
            floorIndicator.style.top = '60px';
            floorIndicator.style.left = '10px';
            floorIndicator.style.backgroundColor = 'rgba(0,0,0,0.7)';
            floorIndicator.style.color = 'white';
            floorIndicator.style.padding = '10px';
            floorIndicator.style.borderRadius = '5px';
            floorIndicator.style.fontFamily = "'Minecraft', Arial, sans-serif";
            document.body.appendChild(floorIndicator);
            
            // Update floor indicator in the animation loop
            setInterval(() => {
                if (yawObject && yawObject.position) {
                    if (yawObject.position.y < FLOOR_HEIGHT) {
                        floorIndicator.textContent = "Ground Floor";
                    } else {
                        floorIndicator.textContent = "Second Floor";
                    }
                }
            }, 200);
        }
        
        // Add a minimap to help with navigation
        function addMinimap() {
            const minimap = document.createElement('canvas');
            minimap.id = 'minimap';
            minimap.width = 150;
            minimap.height = 150;
            minimap.style.position = 'fixed';
            minimap.style.bottom = '20px';
            minimap.style.right = '20px';
            minimap.style.border = '2px solid white';
            minimap.style.borderRadius = '5px';
            minimap.style.backgroundColor = 'rgba(0,0,0,0.7)';
            document.body.appendChild(minimap);
            
            // Update minimap in animation loop
            setInterval(() => {
                if (!yawObject || !yawObject.position) return;
                
                const ctx = minimap.getContext('2d');
                ctx.clearRect(0, 0, minimap.width, minimap.height);
                
                // Draw the museum outline
                const scale = 3; // Scale factor
                const centerX = minimap.width / 2;
                const centerY = minimap.height / 2;
                
                // Fill with background
                ctx.fillStyle = 'rgba(0,0,0,0.5)';
                ctx.fillRect(0, 0, minimap.width, minimap.height);
                
                // Draw the museum walls
                ctx.strokeStyle = 'white';
                ctx.lineWidth = 2;
                ctx.strokeRect(
                    centerX - (MUSEUM_WIDTH * scale) / 2,
                    centerY - (MUSEUM_DEPTH * scale) / 2,
                    MUSEUM_WIDTH * scale,
                    MUSEUM_DEPTH * scale
                );
                
                // Draw stairs
                ctx.fillStyle = 'yellow';
                ctx.beginPath();
                ctx.arc(
                    centerX - (MUSEUM_WIDTH/4) * scale,
                    centerY - (MUSEUM_DEPTH/4) * scale,
                    5, 0, Math.PI * 2
                );
                ctx.fill();
                
                // Draw player position
                const playerX = centerX + (yawObject.position.x * scale / BLOCK_SIZE);
                const playerZ = centerY + (yawObject.position.z * scale / BLOCK_SIZE);
                
                ctx.fillStyle = 'red';
                ctx.beginPath();
                ctx.arc(playerX, playerZ, 3, 0, Math.PI * 2);
                ctx.fill();
                
                // Draw player direction
                const dirX = Math.sin(yawObject.rotation.y) * 7;
                const dirZ = Math.cos(yawObject.rotation.y) * 7;
                
                ctx.beginPath();
                ctx.moveTo(playerX, playerZ);
                ctx.lineTo(playerX + dirX, playerZ - dirZ);
                ctx.strokeStyle = 'red';
                ctx.stroke();
                
                // Draw text for current floor
                ctx.fillStyle = 'white';
                ctx.font = '10px Arial';
                ctx.textAlign = 'center';
                if (yawObject.position.y < FLOOR_HEIGHT) {
                    ctx.fillText("Ground Floor", centerX, 15);
                } else {
                    ctx.fillText("Second Floor", centerX, 15);
                }
            }, 100);
        }
        
        // Add a help panel
        function addHelpPanel() {
            const helpButton = document.createElement('button');
            helpButton.textContent = "?";
            helpButton.style.position = 'fixed';
            helpButton.style.bottom = '20px';
            helpButton.style.left = '20px';
            helpButton.style.width = '30px';
            helpButton.style.height = '30px';
            helpButton.style.borderRadius = '50%';
            helpButton.style.backgroundColor = '#5d8c3a';
            helpButton.style.border = '2px solid #3f6527';
            helpButton.style.color = 'white';
            helpButton.style.fontSize = '18px';
            helpButton.style.cursor = 'pointer';
            document.body.appendChild(helpButton);
            
            const helpPanel = document.createElement('div');
            helpPanel.style.position = 'fixed';
            helpPanel.style.left = '50%';
            helpPanel.style.top = '50%';
            helpPanel.style.transform = 'translate(-50%, -50%)';
            helpPanel.style.backgroundColor = 'rgba(0,0,0,0.9)';
            helpPanel.style.color = 'white';
            helpPanel.style.padding = '20px';
            helpPanel.style.borderRadius = '10px';
            helpPanel.style.fontFamily = "'Minecraft', Arial, sans-serif";
            helpPanel.style.maxWidth = '400px';
            helpPanel.style.display = 'none';
            helpPanel.style.zIndex = '1000';
            
            helpPanel.innerHTML = `
                <h2>Minecraft Museum Controls</h2>
                <ul>
                    <li>WASD - Move around</li>
                    <li>Mouse - Look around</li>
                    <li>Space - Jump</li>
                    <li>Shift - Sprint</li>
                    <li>C - Crouch</li>
                    <li>E - Customize artwork (when looking at a painting)</li>
                </ul>
                <p>Look at paintings to see information about them.</p>
                <p>You can climb on chairs to reach higher areas.</p>
                <p>The stairs will take you to the second floor.</p>
                <button id="closeHelp" style="background: #5d8c3a; border: 2px solid #3f6527; padding: 5px 10px; color: white; cursor: pointer;">Close</button>
            `;
            
            document.body.appendChild(helpPanel);
            
            helpButton.addEventListener('click', () => {
                helpPanel.style.display = 'block';
            });
            
            document.getElementById('closeHelp').addEventListener('click', () => {
                helpPanel.style.display = 'none';
            });
        }

        // Start the app
        init().then(() => {
            // Add UI elements after initialization
            addFloorIndicator();
            addMinimap();
            addHelpPanel();
        });
    </script>
</body>
</html>